# 저전력 블루투스 (BLE)

[1. 구성](#구성)

[2. 네트워크 토폴로지](#네트워크-토폴로지)



## 구성

#### 표준 규격 기반 지원

- BR/EDR (기존 블루투스)

- BLE (저전력 블루투스)

- 단일 모드 디바이스 (BLE, 블루투스 스마트)

  BLE를 구현한 디바이스로써 단일 모드와 듀얼 모드 디바이스들과 통신할 수 있지만 BR/EDR만 지원하는 디바이스는 불가능

- 듀얼 모드 디바이스 (BR/EDR/LE, 블루투스 스마트 레디)

  BR/EDR 과 BLE를 모두 구현한 디바이스로 어떤 블루투스 디바이스와도 통신 가능

#### 칩 카운트 기반

가장 일반적인 세 가지 구성

1. SoC (시스템 온 칩)

   애플리케이션, 호스트, 컨트롤러를 실행하는 단일 IC

2. HCI를 통한 듀얼 IC

   하나의 IC가 애플리케이션과 호스트를 실행시키고 HCI를 사용하여 컨트롤러를 실행시키는 두 번째 IC와 통신

3. 여결 장치와 듀얼 IC

   하나의 IC가 애플리케이셔을 실행하고 호스트와 컨트롤러에서 모두 실행되느 두 번째 IC와 독점적인 프로토콜을 사용하여 통신

> 단일 직접 회로 = IC



### 네트워크 토폴로지

저전력 블루투스 디바이스는 **방송** 또는 **연결** 이라는 두 가지 방식으로 외부와 통신할 수 있음



#### 방송

방송은 디바이스가 하나 이상의 피어로 데이터를 전송하는 유일한 방법이다. 또한, 빠르고 사용하기 쉽다. 정해진 시간이나 다중 디바이스들에 소량의 데이터만 밀어 넣고 싶을 때 좋은 선택이 된다.

방송은 두 가지 별도의 역할을 정의한다

1. 브로드캐스터

   비접속 게시 (Advertising) 패킷을 받고 싶어하는 자에게 정기적으로 전송

2. 옵저버

   현재 방송 중인 비접속 게시 패킷을 수신하기 위해 미리 설정된 주파수를 반복적으로 검색



#### 연결

양방향으로 데이터를 전송하는 경우나 수용 가능한 게시 페이로드보다 더 많은 데이터가 있는 경우, 연결을 사용해야 한다.

연결은 두 디바이스 사이의 패킷들의 영구적, 주기적 데이터 교환을 말한다.

그러므로 데이터가 연결에 관련된 두 피어 사이에서만 송신과 수신이 된다. 즉 비공개이다.



연결은 다음 두 개의 역할을 포함한다.

1. 중앙 장치 (마스터)

   반복적으로 접속 가능한 게시 패킷에 대한 프리셋 주파수를 스캔하고 적절할 때 연결을 초기화

   연결이 설정되면 중앙 장치 (마스터)는 타이밍을 관리하고 주기적인 데이터 교환을 개시

2. 주변 장치 (슬레이브)

   정기적으로 접속 가능한 게시 패킷을 보내고 들어오는 연결을 수용하는 장치

   한번 활성화된 연결에서 주변 장치느 중앙 장치의 정기적인 타이밍과 함께 정기적인 교환 데이터를 따름

   

연결을 시작하기 위해  중앙 장치는 접속 가능한 게시 패킷을 주변 장치로부터 선택하고 두 장치 사이에 전용 연결을 설정하는 요청을 주변 장치로 전송.

연결이 설정되고 나면 주변 장치는 게시를 멈추고 양방향으로 데이터의 교환을 할 수 있음



### 프로토콜 대 프로파일

##### 프로토콜

데이터가 피어 간에 효과적으로 전송되도록 허용하는 서로 다른 패킷 포맷, 라우팅, 멀티플렉싱, 인코딩, 디코딩을 구현하는 계층이다.

##### 프로파일

프로토콜이 일반적이거나 특정한 경우의 특정한 목표를 달성하기 위해 어떻게 사용되어야 하는가를 정의한다.

- 일반 프로파일

  규격에 의해 정의

  - 일반 액세스 프로파일 (GAP)

    역할, 절차, 디바이스가 데이터를 브로드캐스트하게 해주는 모드

    낮은 레벨의 무선 프로토콜의 사용 모델을 다룬다.

    BLE의 최상위 제어 계층으로 모든 BLE 디바이스들에게 필수이며 준수해야 한다.

  - 일반 속성 프로파일 (GATT)

    BLE의 데이터 교환을 처리함
    
    디바이스 간에 데이터를 발견하고, 읽고, 쓰고, 밀어 넣을 수 있도록 허용하기 위해 기본 데이터 모델과 절차를 정의한다.



## 프로토콜 기초

프로토콜 스택의 기본 구성요소

1. 애플리케이션

   최상의 계층

   애플리케이션이 구현하는 실제 유스케이스에 관한 모든 것의 로직, 사용자 인터페이스, 데이터 처리를 포함

2. 호스트

   다음과 같은 계층을 포함

   - 일반 액세스 프로파일 (GAP)
   - 일반 속성 프로파일 (GATT)
   - 논리적 링크 제어 및 적용 프로토콜 (L2CAP)
   - 속성 프로토콜 (ATT)
   - 보안 관리자 (SM)
   - 호스트 측, 호스트 컨트롤러 인터페이스 (HCI)

3. 컨트롤러

   - 컨트롤러 측, 호스트 컨트롤러 인터페이스 (HCI)
   - 링크 레이어 (LL)
   - 물리적 계층 (PHY)



프로토콜 스택

| 애플리케이션                   | APP               |
| ------------------------------ | ----------------- |
| 호스트                         | GAP, GATT         |
|                                | SM, GATT          |
|                                | L2ACP             |
| HCI 호스트 컨트롤러 인터페이스 |                   |
| 컨트롤러                       | 링크 레이어 (LL)  |
|                                | 물리적 계층 (PHY) |



#### 물리적 계층 (PHY)

변조 및 아날로그 신호를 복조 및 디지털 기호로 변환할 수 있는 아날로그 통신 회로를 실질적으로 포함.

디바이스 근처의 강한 전송 전력으로 디바이스들이 심한 간섭을 경험하는 것 같은 영향을 최소화.



#### 링크 계층

PHY 와 직접 인터페이스 하는 부분

디바이스가 다른 디바이스에 연결되는 방법인 무선의 연결 상태를 관리

연결을 시작할 디바이스는 마스터가 되고, 자신의 가용성을 게시하고 연결을 수용할 디바이스는 슬레이브가 된다.

링크 계층은 다음과 같은 역할을 정의하

- 애드버타이저

  게시 패킷을 전송하는 디바이스

- 스캐너

  게시 패킷을 검사하는 디바이스

- 마스터

  연결을 시작하고 과리하는 디바이스

- 슬레이브

  연결 요청을 받아 마스터의 타이밍을 따르는 디바이스

이 역할들은 연결이 활성화 되었을 때 (마스터, 슬레이브), 활성화가 아닐 때 (애드버타이저, 스캐너) 로 나눌 수 있다.



블루투스 디바이스의 기본 식별자는 블루투스 비다이스 어드레스다. 아래와 같은 두 가지 유형의 디바이스가 있다.

- 퍼블릭 디바이스 어드레스

  고정되는 것. BR/EDR이다. 디바이스 수명 기간 동안 변경되지 않는다.

- 랜덤 디바이스 어드레스

  실행 시에 동적으로 생성. 실용적인 BLE 유스케이스들이 많다.



BLE는 하나의 패킷 포맷과 두개의 패킷 유형(게시, 데이터패킷)을 가진다.

- 게시 패킷
  - 전체 연결 설정의 오버헤드가 필요하지 않는 애플리케이션에 대한 데이터 방송
  - 슬레이브를 발견하고 이들에게 연결

이러한 게시 패킷은 애드버타이저에 의해 무선상에 단순히 무조건적으로 방송된다.

애드버타이저와 스캐너는 동기화되지 않기 때문에 무작위로 겹칠 때만 성공적으로 수신이 가능하다.



##### 연결

마스터가 먼저 요청을 수락할 애드버타이저를 찾기 위해 검색을 시작한다. 적합한 게시 슬레이브가 발견되면 마스터는 연결 리퀘스트 패킷을 슬레이브로 보내고 슬레이브의 응답에 따라 연결을 설정한다.

슬레이브와 마스터 간에 미리 정의한 시간에 대한 데이터 교환의 절차



#### 호스트 컨트롤러 인터페이스 (HCI)

시리얼 인터페이스를 통해 일어날 수 있는 호스트와 컨트롤러 사이의 통신을 허용하는 표준 프로토콜



#### 논리적 링크 제어 및 적용 프로토콜 (L2CAP)

상위 계층에서 다중 프로토콜을 얻어서 프로토콜 멀티플렉서 역할을 하고, 이들을 표준 BLE 패킷 포맷(혹은 그 반대)으로 캡슐화한다.

상위 계층으로부터 큰 패킷들을 취하고, BLE 패킷에 맞게 단편화 및 재조합을 수행한다.

속성 프로토콜(ATT)은 데이터 교환의 기본을 형성

보안 관리자 프로토콜(SMP)는 피어들 사이에서 보안 키를 생성하고 배포할 수 있는 프레임워크를 제공한다.



#### 속성 프로토콜 (ATT)

디바이스에 의해 제시된 속성을 기반으로 하는 간단한 클라이언트/서버 비보존형 프로토콜이다.



#### 보안 관리자 (SM)

블루투스 프로토콜 스택과 함께 보안 키를 생성하고 교환하는 능력

다음 세 가지 절차에 대한 지원을 제공함

- 페어링

  임시 공통 보안 암호키 생성

- 본딩

  두 디바이스 사이에서 이들이 다시 결합(bond) 절차를 수행할 필요 없이 후속 연결의 보안 링크를 신속하게 설정할 수 있도록 영구적인 결합을 생성

- 암호화 재설정

  안전하고 암호화된 후속 연결을 재설정하기 위해 이들 키 값을 어떻게 사용할 것인지 정의하



#### 일반 속성 프로파일 (GATT)

